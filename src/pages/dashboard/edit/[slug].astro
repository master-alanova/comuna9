---
import Layout from "../../../layouts/Layout.astro";
import { supabase } from "../../../lib/supabase";

const { slug } = Astro.params;
// const user = Astro.locals.user;

const user = import.meta.env.ADMIN_USERNAME;
// 1. Verificaciones de seguridad
if (!user) return Astro.redirect("/login");
if (!slug) return Astro.redirect("/dashboard");

// 2. Definimos las variables de estado (Esto faltaba y causaba el error)
let error = null;
let success = false;
const content = ""; // Definimos vacío para evitar errores si tu HTML lo llama

// 3. Definimos las categorías (Esto faltaba antes)
const categories = [
    "Desayunos & Brunch",
    "Cafetería de Especialidad",
    "Platos Principales",
    "Postres",
    "Bebidas",
];

// 4. Lógica para GUARDAR los cambios (POST)
if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        formData.append("slug", slug); // Aseguramos que el slug vaya en los datos

        // Llamamos a tu API (que ya arreglaste para usar Supabase)
        const response = await fetch(new URL("/api/menu/update", Astro.url), {
            method: "POST",
            body: formData,
        });

        if (response.ok) {
            success = true;
        } else {
            const data = await response.json();
            error = data.error || "Error al actualizar el item";
        }
    } catch (e) {
        error = "Error al procesar la solicitud";
        console.error(e);
    }
}

// 5. Buscar el item actual en la base de datos para mostrarlo
const { data: item, error: dbError } = await supabase
    .from("menu_items")
    .select("*")
    .eq("slug", slug)
    .single();

if (dbError || !item) {
    console.error("Item no encontrado:", dbError);
    return Astro.redirect("/dashboard");
}
---

<Layout title={`Editar ${item.title} - Dashboard`}>
    <main class="dashboard">
        <div class="dashboard-header">
            <div class="container">
                <a href="/dashboard" class="dashboard-logo"
                    >← Volver al Dashboard</a
                >
            </div>
        </div>

        <div class="dashboard-content">
            <div class="container">
                <h1>Editar Item: {item.title}</h1>

                {
                    error && (
                        <div class="error-message" role="alert">
                            {error}
                        </div>
                    )
                }

                {
                    success && (
                        <div class="success-message" role="alert">
                            Item actualizado exitosamente!
                        </div>
                    )
                }

                <form method="POST" class="menu-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="title">Título *</label>
                            <input
                                type="text"
                                id="title"
                                name="title"
                                value={item.title}
                                required
                            />
                        </div>

                        <div class="form-group">
                            <label for="category">Categoría *</label>
                            <select id="category" name="category" required>
                                {
                                    categories.map((cat) => (
                                        <option
                                            value={cat}
                                            selected={cat === item.category}
                                        >
                                            {cat}
                                        </option>
                                    ))
                                }
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="price">Precio</label>
                            <input
                                type="number"
                                id="price"
                                name="price"
                                value={item.price || ""}
                                min="0"
                                step="any"
                                placeholder="3500"
                            />
                        </div>

                        <div class="form-group">
                            <label for="order">Orden de visualización</label>
                            <input
                                type="number"
                                id="order"
                                name="order"
                                value={item.order}
                                min="0"
                            />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">Descripción</label>
                        <textarea id="description" name="description" rows="3"
                            >{item.description || ""}</textarea
                        >
                    </div>

                    <!-- TODO: Implementar contenido adicional 
                    <div class="form-group">
                        <label for="content"
                            >Contenido adicional (Markdown)</label
                        >
                        <textarea id="content" name="content" rows="5"
                            >{content}</textarea
                        >
                    </div>
                    -->

                    <div class="form-group">
                        <label for="image">URL de imagen</label>
                        <input
                            type="text"
                            id="image"
                            name="image"
                            value={item.image || ""}
                            placeholder="/images/menu-item.jpg"
                        />
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input
                                type="checkbox"
                                name="published"
                                value="true"
                                checked={item.published}
                            />
                            Publicado
                        </label>
                    </div>

                    <div class="form-actions">
                        <a href="/dashboard" class="btn">Cancelar</a>
                        <button type="submit" class="btn btn-primary"
                            >Guardar Cambios</button
                        >
                    </div>
                </form>
            </div>
        </div>
    </main>
</Layout>

<style>
    .dashboard {
        min-height: 100vh;
        background-color: var(--color-bg-light);
    }

    .dashboard-header {
        background-color: var(--color-bg-dark);
        color: var(--color-text-light);
        padding: 1.5rem 0;
    }

    .dashboard-logo {
        font-family: var(--font-primary);
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-secondary);
    }

    .dashboard-content {
        padding: var(--spacing-xl) 0;
    }

    .dashboard-content h1 {
        font-size: 2.5rem;
        font-weight: 300;
        margin-bottom: var(--spacing-lg);
        color: var(--color-primary);
    }

    .error-message {
        background-color: #fee;
        border: 1px solid #fcc;
        color: #c33;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: var(--spacing-md);
    }

    .success-message {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: var(--spacing-md);
    }

    .menu-form {
        background-color: #fff;
        padding: var(--spacing-lg);
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        max-width: 900px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 0.5rem;
        color: var(--color-primary);
    }

    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.875rem 1rem;
        background-color: #fff;
        border: 1px solid rgba(26, 26, 26, 0.2);
        border-radius: var(--border-radius);
        font-size: 1rem;
        font-family: var(--font-secondary);
        transition: all var(--transition-fast);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1);
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        text-transform: none;
    }

    .checkbox-label input[type="checkbox"] {
        width: auto;
        cursor: pointer;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: var(--spacing-lg);
    }

    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }

        .menu-form {
            padding: var(--spacing-md);
        }
    }
</style>
