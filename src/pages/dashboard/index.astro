---
import Layout from "../../layouts/Layout.astro";
import { formatPrice } from "../../lib/utils";
import { supabase } from "../../lib/supabase";

const user = import.meta.env.ADMIN_USERNAME;
if (!user) {
    return Astro.redirect("/login");
}

// === CAMBIO AQUÍ: Leemos todos los items de la DB ===
const { data: menuItems } = await supabase
    .from("menu_items")
    .select("*")
    .order("category", { ascending: true })
    .order("order", { ascending: true });

const sortedItems = menuItems || [];

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    if (formData.get("action") === "logout") {
        // Delete the session cookie
        Astro.cookies.delete("session", { path: "/" });
        return Astro.redirect("/login", 302);
    }
}
---

<Layout title="Dashboard - Comuna 9">
    <main class="dashboard">
        <div class="dashboard-header">
            <div class="container">
                <div class="dashboard-nav">
                    <a href="/" class="dashboard-logo">← COMUNA 9</a>
                    <div class="dashboard-user">
                        <span>Hola, {user.username}</span>
                        <form method="POST" style="display: inline;">
                            <input type="hidden" name="action" value="logout" />
                            <button type="submit" class="btn-logout"
                                >Salir</button
                            >
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-content">
            <div class="container">
                <div class="dashboard-title-bar">
                    <h1>Gestión de Carta</h1>
                    <a href="/dashboard/new" class="btn btn-primary"
                        >+ Agregar Nuevo Item</a
                    >
                </div>

                <div class="menu-items-list">
                    {
                        sortedItems.map((item) => (
                            <div class="menu-item-row">
                                <div class="item-info">
                                    <h3>{item.title}</h3>
                                    <p class="item-category">{item.category}</p>
                                    {item.description && (
                                        <p class="item-description">
                                            {item.description}
                                        </p>
                                    )}
                                </div>
                                <div class="item-meta">
                                    {item.price && (
                                        <span class="item-price">
                                            {formatPrice(item.price)}
                                        </span>
                                    )}
                                    <span
                                        class="item-status"
                                        class:list={[
                                            item.published
                                                ? "published"
                                                : "draft",
                                        ]}
                                    >
                                        {item.published
                                            ? "Publicado"
                                            : "Borrador"}
                                    </span>
                                </div>
                                <div class="item-actions">
                                    <a
                                        href={`/dashboard/edit/${item.slug}`}
                                        class="btn btn-small"
                                    >
                                        Editar
                                    </a>
                                    <form
                                        method="POST"
                                        action={`/api/menu/delete`}
                                        style="display: inline-block;"
                                    >
                                        <input
                                            type="hidden"
                                            name="slug"
                                            value={item.slug}
                                        />
                                        <button
                                            type="submit"
                                            class="btn btn-small btn-danger"
                                            onclick="return confirm('¿Estás seguro de eliminar este item?')"
                                        >
                                            Eliminar
                                        </button>
                                    </form>
                                </div>
                            </div>
                        ))
                    }
                </div>
            </div>
        </div>
    </main>
</Layout>

<style>
    .dashboard {
        min-height: 100vh;
        background-color: var(--color-bg-light);
    }

    .dashboard-header {
        background-color: var(--color-bg-dark);
        color: var(--color-text-light);
        padding: 1.5rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .dashboard-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .dashboard-logo {
        font-family: var(--font-primary);
        font-size: 1.5rem;
        font-weight: 600;
        letter-spacing: 0.15em;
        color: var(--color-secondary);
    }

    .dashboard-user {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .btn-logout {
        background: none;
        border: 1px solid var(--color-secondary);
        color: var(--color-secondary);
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 0.875rem;
        font-family: var(--font-secondary);
        transition: all var(--transition-fast);
    }

    .btn-logout:hover {
        background-color: var(--color-secondary);
        color: var(--color-primary);
    }

    .dashboard-content {
        padding: var(--spacing-xl) 0;
    }

    .dashboard-title-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .dashboard-title-bar h1 {
        font-size: 2.5rem;
        font-weight: 300;
        color: var(--color-primary);
    }

    .menu-items-list {
        background-color: #fff;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }

    .menu-item-row {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 2rem;
        padding: 1.5rem;
        border-bottom: 1px solid rgba(26, 26, 26, 0.1);
        align-items: center;
    }

    .menu-item-row:last-child {
        border-bottom: none;
    }

    .item-info h3 {
        font-size: 1.25rem;
        font-weight: 500;
        margin-bottom: 0.25rem;
        color: var(--color-primary);
    }

    .item-category {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--color-accent);
        margin-bottom: 0.5rem;
    }

    .item-description {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
        margin: 0;
    }

    .item-meta {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .item-price {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-accent);
    }

    .item-status {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .item-status.published {
        background-color: #d4edda;
        color: #155724;
    }

    .item-status.draft {
        background-color: #f8d7da;
        color: #721c24;
    }

    .item-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-small {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        min-width: 100px;
        text-align: center;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .btn-danger {
        border-color: #dc3545;
        color: #dc3545;
    }

    .btn-danger:hover {
        background-color: #dc3545;
        color: white;
        opacity: 1;
    }

    @media (max-width: 968px) {
        .menu-item-row {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .item-actions {
            justify-content: flex-start;
        }

        .dashboard-title-bar {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
    }
</style>
