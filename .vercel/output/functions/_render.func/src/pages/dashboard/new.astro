---
import Layout from "../../layouts/Layout.astro";

const categories = [
    "Desayunos & Brunch",
    "Cafetería de Especialidad",
    "Platos Principales",
    "Postres",
    "Bebidas",
];

let error: string | null = null;
let success = false;

if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const response = await fetch(new URL("/api/menu/create", Astro.url), {
            method: "POST",
            body: formData,
        });

        if (response.ok) {
            success = true;
        } else {
            error = "Error al crear el item";
        }
    } catch (e) {
        error = "Error al procesar la solicitud";
    }
}
---

<Layout title="Nuevo Item - Dashboard">
    <main class="dashboard">
        <div class="dashboard-header">
            <div class="container">
                <a href="/dashboard" class="dashboard-logo"
                    >← Volver al Dashboard</a
                >
            </div>
        </div>

        <div class="dashboard-content">
            <div class="container">
                <h1>Agregar Nuevo Item al Menú</h1>

                {
                    error && (
                        <div class="error-message" role="alert">
                            {error}
                        </div>
                    )
                }

                {
                    success && (
                        <div class="success-message" role="alert">
                            Item creado exitosamente. Redirigiendo...
                        </div>
                    )
                }

                <form
                    method="POST"
                    class="menu-form"
                    enctype="multipart/form-data"
                >
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="title">Título *</label>
                            <input
                                type="text"
                                id="title"
                                name="title"
                                required
                            />
                        </div>

                        <div class="form-group">
                            <label for="category">Categoría *</label>
                            <select id="category" name="category" required>
                                <option value="">Seleccionar categoría</option>
                                {
                                    categories.map((cat) => (
                                        <option value={cat}>{cat}</option>
                                    ))
                                }
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="price">Precio</label>
                            <input
                                type="number"
                                id="price"
                                name="price"
                                min="0"
                                step="any"
                                placeholder="3500"
                            />
                        </div>

                        <div class="form-group">
                            <label for="order">Orden de visualización</label>
                            <input
                                type="number"
                                id="order"
                                name="order"
                                value="0"
                                min="0"
                            />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">Descripción</label>
                        <textarea id="description" name="description" rows="3"
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label for="content"
                            >Contenido adicional (Markdown)</label
                        >
                        <textarea
                            id="content"
                            name="content"
                            rows="5"
                            placeholder="Puedes usar Markdown aquí para más detalles..."
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label for="image">URL de imagen</label>
                        <input
                            type="text"
                            id="image"
                            name="image"
                            placeholder="/images/menu-item.jpg"
                        />
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input
                                type="checkbox"
                                name="published"
                                value="true"
                                checked
                            />
                            Publicar inmediatamente
                        </label>
                    </div>

                    <div class="form-actions">
                        <a href="/dashboard" class="btn">Cancelar</a>
                        <button type="submit" class="btn btn-primary"
                            >Guardar Item</button
                        >
                    </div>
                </form>
            </div>
        </div>
    </main>
</Layout>

<style>
    .dashboard {
        min-height: 100vh;
        background-color: var(--color-bg-light);
    }

    .dashboard-header {
        background-color: var(--color-bg-dark);
        color: var(--color-text-light);
        padding: 1.5rem 0;
    }

    .dashboard-logo {
        font-family: var(--font-primary);
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-secondary);
    }

    .dashboard-content {
        padding: var(--spacing-xl) 0;
    }

    .dashboard-content h1 {
        font-size: 2.5rem;
        font-weight: 300;
        margin-bottom: var(--spacing-lg);
        color: var(--color-primary);
    }

    .error-message {
        background-color: #fee;
        border: 1px solid #fcc;
        color: #c33;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: var(--spacing-md);
    }

    .success-message {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: var(--spacing-md);
    }

    .menu-form {
        background-color: #fff;
        padding: var(--spacing-lg);
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        max-width: 900px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 0.5rem;
        color: var(--color-primary);
    }

    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.875rem 1rem;
        background-color: #fff;
        border: 1px solid rgba(26, 26, 26, 0.2);
        border-radius: var(--border-radius);
        font-size: 1rem;
        font-family: var(--font-secondary);
        transition: all var(--transition-fast);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1);
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        text-transform: none;
    }

    .checkbox-label input[type="checkbox"] {
        width: auto;
        cursor: pointer;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: var(--spacing-lg);
    }

    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }

        .menu-form {
            padding: var(--spacing-md);
        }
    }
</style>

<script>
    // Auto-generate slug from title
    const titleInput = document.getElementById("title") as HTMLInputElement;
    titleInput?.addEventListener("input", () => {
        console.log(
            "Slug preview:",
            titleInput.value.toLowerCase().replace(/\s+/g, "-"),
        );
    });

    // Handle redirect after success
    const successMessage = document.querySelector(".success-message");
    if (successMessage) {
        setTimeout(() => {
            window.location.href = "/dashboard";
        }, 1500);
    }
</script>
